name: Fetch Substack RSS

on:
  schedule:
    # Runs daily at 9am UTC
    - cron: '0 9 * * *'
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  fetch-rss:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch and convert RSS to JSON
        run: |
          # Fetch with full headers
          curl -sL \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            -H "Accept: application/rss+xml, application/xml, text/xml" \
            "https://asrinsights.substack.com/feed" -o feed.xml
          
          # Debug: show first 500 chars
          echo "=== First 500 chars of response ==="
          head -c 500 feed.xml
          echo ""
          echo "==================================="
          
          # Check if we got content
          if [ ! -s feed.xml ]; then
            echo "Error: Empty response from Substack"
            exit 1
          fi
          
          pip install feedparser --quiet
          
          python3 << 'EOF'
          import feedparser
          import json

          feed = feedparser.parse('feed.xml')

          if feed.bozo and not feed.entries:
              print(f"Parse error: {feed.bozo_exception}")
              exit(1)

          items = []
          for entry in feed.entries:
              items.append({
                  'title': entry.get('title', ''),
                  'link': entry.get('link', ''),
                  'pubDate': entry.get('published', ''),
                  'description': entry.get('summary', '')
              })

          with open('articles.json', 'w') as f:
              json.dump({'items': items}, f, indent=2)
          
          print(f"Successfully parsed {len(items)} articles")
          EOF
          
          rm feed.xml

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add articles.json
          git diff --quiet --cached || git commit -m "Update articles.json"
          git push