name: Fetch Substack RSS

on:
  schedule:
    # Runs daily at 9am UTC
    - cron: '0 9 * * *'
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  fetch-rss:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch and convert RSS to JSON
        run: |
          curl -s -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            "https://asrinsights.substack.com/feed" -o feed.xml
          
          # Check if we got content
          if [ ! -s feed.xml ]; then
            echo "Error: Empty response from Substack"
            exit 1
          fi
          
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          import json

          with open('feed.xml', 'r') as f:
              xml_content = f.read()

          root = ET.fromstring(xml_content)

          items = []
          for item in root.findall('.//item'):
              title = item.find('title')
              link = item.find('link')
              pub_date = item.find('pubDate')
              description = item.find('description')
              
              items.append({
                  'title': title.text if title is not None else '',
                  'link': link.text if link is not None else '',
                  'pubDate': pub_date.text if pub_date is not None else '',
                  'description': description.text if description is not None else ''
              })

          with open('articles.json', 'w') as f:
              json.dump({'items': items}, f, indent=2)
          
          print(f"Successfully parsed {len(items)} articles")
          EOF
          
          rm feed.xml

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add articles.json
          git diff --quiet --cached || git commit -m "Update articles.json"
          git push