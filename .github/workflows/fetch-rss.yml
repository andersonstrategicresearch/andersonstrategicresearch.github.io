name: Fetch Substack RSS

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  fetch-rss:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch RSS via Toptal feed2json
        run: |
          curl -s "https://www.toptal.com/developers/feed2json/convert?url=https://asrinsights.substack.com/feed" -o response.json
          
          # Check if we got valid JSON with items
          if ! jq -e '.items' response.json > /dev/null 2>&1; then
            echo "Error: Invalid response from feed2json"
            cat response.json
            exit 1
          fi
          
          # Convert Toptal format to our format
          jq '{items: [.items[] | {title: .title, link: .url, pubDate: .date_published, description: .summary}]}' response.json > articles.json
          
          echo "Successfully fetched $(jq '.items | length' articles.json) articles"
          rm response.json

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add articles.json
          git diff --quiet --cached || git commit -m "Update articles.json"
          git push
